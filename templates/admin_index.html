{% extends "base.html" %}

{% block title %}Administração do Sistema{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Toast container for visual feedback -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080;"></div>

    {# Render flashed messages as toasts (if any) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flashedToasts" style="display:none;">
        {% for category, msg in messages %}
        <div class="flashed-message" data-category="{{ category }}">{{ msg }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="mb-5 text-center">
        <h1 class="fw-bold text-primary mb-2"><i class="bi bi-gear-fill me-2"></i>Administração</h1>
        <p class="text-muted">Gerencie configurações, identidade visual e manutenção do sistema</p>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-12 col-lg-8">

            <!-- Carteirinha Settings -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-card-heading me-2"></i>Configurações da Carteirinha
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/admin" class="row g-3">
                        <div class="col-md-6">
                            <label for="CARTEIRINHA_ESCOLA" class="form-label">Escola</label>
                            <input type="text" class="form-control" id="CARTEIRINHA_ESCOLA" name="CARTEIRINHA_ESCOLA"
                                value="{{ config.escola }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="CARTEIRINHA_TELEFONE" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="CARTEIRINHA_TELEFONE"
                                name="CARTEIRINHA_TELEFONE" value="{{ config.telefone }}" required>
                        </div>
                        <div class="col-md-8">
                            <label for="CARTEIRINHA_ENDERECO" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="CARTEIRINHA_ENDERECO"
                                name="CARTEIRINHA_ENDERECO" value="{{ config.endereco }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="CARTEIRINHA_VALIDADE" class="form-label">Validade</label>
                            <input type="text" class="form-control" id="CARTEIRINHA_VALIDADE"
                                name="CARTEIRINHA_VALIDADE" value="{{ config.validade }}" required>
                        </div>
                        <div class="col-12 text-end mt-4">
                            <button type="submit" class="btn btn-success px-4"><i class="bi bi-check-lg me-2"></i>Salvar
                                Alterações</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Logo & Signature -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-palette me-2"></i>Identidade Visual</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/admin" enctype="multipart/form-data" class="row g-3">
                        <div class="col-md-6">
                            <label for="assinatura" class="form-label">Nova Assinatura (PNG)</label>
                            <input class="form-control" type="file" id="assinatura" name="assinatura" accept=".png">
                            <div class="form-text">Recomendado: Fundo transparente</div>
                        </div>
                        <div class="col-md-6">
                            <label for="logo" class="form-label">Nova Logo (SVG)</label>
                            <input class="form-control" type="file" id="logo" name="logo" accept=".svg">
                            <div class="form-text">Formato vetorial SVG</div>
                        </div>
                        <div class="col-12 text-end mt-4">
                            <button type="submit" class="btn btn-primary px-4"><i
                                    class="bi bi-upload me-2"></i>Atualizar Imagens</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Telegram Token -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-telegram me-2"></i>Integração Telegram</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/admin" class="row g-3">
                        <div class="col-12">
                            <label for="TELEGRAM_TOKEN" class="form-label">Token do Bot</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                                <input type="text" class="form-control" id="TELEGRAM_TOKEN" name="TELEGRAM_TOKEN"
                                    value="{{ token }}" required placeholder="Cole o token aqui">
                            </div>
                        </div>
                        <div class="col-12 text-end mt-4">
                            <button type="submit" class="btn btn-success px-4"><i class="bi bi-check-lg me-2"></i>Salvar
                                Token</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-12 col-lg-4">

            <!-- Danger Zone -->
            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Zona de Perigo</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold text-danger">Limpar Dados</h6>
                    <p class="small text-muted mb-3">Esta ação apagará todos os registros e é irreversível. Requer
                        verificação tripla.</p>
                    <button id="openClearModal" class="btn btn-outline-danger w-100">
                        <i class="bi bi-trash3 me-2"></i>Iniciar Limpeza
                    </button>
                </div>
            </div>

            <!-- Backup & Restore -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-hdd-network me-2"></i>Manutenção</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="fw-bold mb-2">Backup</h6>
                        <p class="small text-muted mb-2">Gera um arquivo ZIP com todos os dados.</p>
                        <button id="backupBtn" class="btn btn-primary w-100">
                            <i class="bi bi-download me-2"></i>Criar Backup
                        </button>
                    </div>
                    <hr>
                    <div>
                        <h6 class="fw-bold mb-2">Restauração</h6>
                        <p class="small text-muted mb-2">Restaura dados a partir de um backup ZIP.</p>
                        <button id="restoreBtn" class="btn btn-outline-success w-100">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals (Preserved Logic) -->

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Restaurar Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle me-1"></i> Atenção: Esta operação irá sobrescrever os dados
                    atuais.
                </div>
                <div class="mb-3">
                    <label class="form-label">Arquivo ZIP</label>
                    <input id="backupFileInput" type="file" accept=".zip" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Confirmação</label>
                    <input id="restorePhraseInput" class="form-control" placeholder="Digite: RESTAURAR BACKUP">
                </div>
                <div id="restoreError" class="text-danger small" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="confirmRestoreBtn" type="button" class="btn btn-success">Confirmar Restauração</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Result Modal -->
<div class="modal fade" id="restoreResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultado da Restauração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="restoreLogContent" class="p-3 bg-light border rounded small"
                    style="white-space:pre-wrap; max-height:400px; overflow:auto;"></pre>
            </div>
            <div class="modal-footer">
                <button id="copyRestoreLog" type="button" class="btn btn-outline-secondary">Copiar Log</button>
                <button id="restoreReloadBtn" type="button" class="btn btn-primary">Fechar e Recarregar</button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Result Modal -->
<div class="modal fade" id="backupResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultado do Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="backupLogContent" class="p-3 bg-light border rounded small"
                    style="white-space:pre-wrap; max-height:400px; overflow:auto;"></pre>
            </div>
            <div class="modal-footer">
                <button id="copyBackupLog" type="button" class="btn btn-outline-secondary">Copiar Log</button>
                <a id="downloadBackupBtn" class="btn btn-success" style="display:none;" href="#" download>Baixar ZIP</a>
                <button id="backupReloadBtn" type="button" class="btn btn-primary">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Data Modal -->
<div class="modal fade" id="clearModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmação de Limpeza</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger fw-bold">Responda as verificações para confirmar:</p>

                <div class="mb-3">
                    <label class="form-label small text-muted">1. Token de Verificação</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light font-monospace">{{ clear_token }}</span>
                        <input id="tokenInput" class="form-control" placeholder="Copie o token">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small text-muted">2. Operação Matemática</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light font-monospace">{{ math_question }}</span>
                        <input id="mathInput" class="form-control" placeholder="Resultado">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small text-muted">3. Frase de Segurança</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light font-monospace">LIMPAR TUDO</span>
                        <input id="phraseInput" class="form-control" placeholder="Digite: LIMPAR TUDO">
                    </div>
                </div>

                <div id="clearError" class="alert alert-danger py-2 small" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="confirmClearBtn" type="button" class="btn btn-danger">Confirmar Limpeza</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Helper: create and show bootstrap toast
        function showToast(message, type) {
            type = type || 'success';
            var toastContainer = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast align-items-center text-bg-light border-0 shadow';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>`;

            // Colorize by type
            if (type === 'success') {
                toast.classList.remove('text-bg-light');
                toast.classList.add('text-bg-success');
            } else if (type === 'error' || type === 'danger') {
                toast.classList.remove('text-bg-light');
                toast.classList.add('text-bg-danger');
            } else if (type === 'info') {
                toast.classList.remove('text-bg-light');
                toast.classList.add('text-bg-info');
            }

            toastContainer.appendChild(toast);
            var bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            // remove after hidden
            toast.addEventListener('hidden.bs.toast', function () { toast.remove(); });
        }

        // Show flashed messages from server as toasts
        var flashed = document.getElementById('flashedToasts');
        if (flashed) {
            var items = flashed.querySelectorAll('.flashed-message');
            items.forEach(function (it) {
                var cat = it.getAttribute('data-category') || 'info';
                var msg = it.textContent || it.innerText || '';
                showToast(msg.trim(), cat === 'success' ? 'success' : (cat === 'error' ? 'danger' : 'info'));
            });
        }

        var clearModalEl = document.getElementById('clearModal');
        var clearModal = new bootstrap.Modal(clearModalEl);
        document.getElementById('openClearModal').addEventListener('click', function () {
            // abrir modal
            document.getElementById('clearError').style.display = 'none';
            document.getElementById('tokenInput').value = '';
            document.getElementById('mathInput').value = '';
            document.getElementById('phraseInput').value = '';
            clearModal.show();
        });

        document.getElementById('confirmClearBtn').addEventListener('click', function () {
            var token = document.getElementById('tokenInput').value.trim();
            var math = document.getElementById('mathInput').value.trim();
            var phrase = document.getElementById('phraseInput').value.trim();
            var err = document.getElementById('clearError');
            if (!token || !math || !phrase) {
                err.textContent = 'Por favor preencha todos os campos de verificação.';
                err.style.display = 'block';
                return;
            }
            var btn = document.getElementById('confirmClearBtn');
            var origHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processando...';

            // Enviar para o servidor
            fetch('/admin/clear_data', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, math: math, phrase: phrase })
            }).then(function (r) {
                // lidar com respostas que não são JSON (por exemplo páginas de erro HTML)
                var ct = r.headers.get('content-type') || '';
                if (ct.indexOf('application/json') !== -1) {
                    return r.json().then(function (data) {
                        if (!r.ok) { throw new Error(data.msg || 'Falha na validação'); }
                        return data;
                    });
                }
                return r.text().then(function (txt) {
                    if (!r.ok) { throw new Error(txt || 'Falha na validação'); }
                    try {
                        var parsed = JSON.parse(txt);
                        return parsed;
                    } catch (e) {
                        return { ok: true };
                    }
                });
            }).then(function (data) {
                // sucesso
                err.style.display = 'none';
                clearModal.hide();
                showToast('Limpeza concluída com sucesso.', 'success');
                window.location.reload();
            }).catch(function (e) {
                err.textContent = e.message || 'Erro ao executar a limpeza.';
                err.style.display = 'block';
                showToast(err.textContent, 'danger');
            }).finally(function () {
                btn.disabled = false;
                btn.innerHTML = origHTML;
            });
        });
        // Backup button: redireciona para rota que gera o zip
        var backupBtn = document.getElementById('backupBtn');
        if (backupBtn) {
            backupBtn.addEventListener('click', function () {
                backupBtn.disabled = true;
                var orig = backupBtn.innerHTML;
                backupBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Criando...';
                fetch('/admin/backup_api', { method: 'GET', credentials: 'same-origin' })
                    .then(function (r) {
                        var ct = r.headers.get('content-type') || '';
                        if (ct.indexOf('application/json') !== -1) {
                            return r.json().then(function (data) { if (!r.ok) throw new Error(data.msg || 'Erro'); return data; });
                        }
                        return r.text().then(function (txt) { if (!r.ok) throw new Error(txt || 'Erro'); try { return JSON.parse(txt); } catch (e) { return { ok: true, msg: txt }; } });
                    }).then(function (data) {
                        // show modal with log and download link
                        var log = (typeof data === 'object') ? JSON.stringify(data, null, 2) : String(data);
                        var el = document.getElementById('backupLogContent');
                        if (el) el.textContent = log;
                        var downloadBtn = document.getElementById('downloadBackupBtn');
                        var startedDownload = false;
                        if (downloadBtn && data.download_url) {
                            downloadBtn.href = data.download_url; downloadBtn.style.display = 'inline-block';
                            // tentar iniciar download automaticamente
                            try {
                                var auto = document.createElement('a');
                                auto.href = data.download_url;
                                auto.download = data.filename || '';
                                auto.style.display = 'none';
                                document.body.appendChild(auto);
                                auto.click();
                                startedDownload = true;
                                setTimeout(function () { try { document.body.removeChild(auto); } catch (e) { } }, 1500);
                                showToast('Download iniciado.', 'info');
                            } catch (e) {
                                startedDownload = false;
                            }
                        }
                        var bmodalEl = document.getElementById('backupResultModal');
                        // Se o download foi iniciado automaticamente, não abrir o modal (fechar caso esteja aberto);
                        if (startedDownload) {
                            try {
                                var resInst = bootstrap.Modal.getInstance(bmodalEl);
                                if (resInst) resInst.hide();
                            } catch (e) { }
                            document.querySelectorAll('.modal-backdrop').forEach(function (el) { el.remove(); });
                            document.body.classList.remove('modal-open');
                        } else {
                            if (bmodalEl) { var bmodal = new bootstrap.Modal(bmodalEl); bmodal.show(); }
                        }
                    }).catch(function (e) {
                        // ensure we show the error log modal so user can see details
                        var el = document.getElementById('backupLogContent');
                        if (el) el.textContent = e.message || String(e);
                        var bmodalEl = document.getElementById('backupResultModal');
                        if (bmodalEl) { var bmodal = new bootstrap.Modal(bmodalEl); bmodal.show(); }
                        showToast(e.message || 'Erro ao criar backup', 'danger');
                    }).finally(function () {
                        backupBtn.disabled = false;
                        backupBtn.innerHTML = orig;
                    });
            });
        }
        // Restore button: abrir modal
        var restoreBtn = document.getElementById('restoreBtn');
        if (restoreBtn) {
            var restoreModalEl = document.getElementById('restoreModal');
            var restoreModal = new bootstrap.Modal(restoreModalEl);
            restoreBtn.addEventListener('click', function () {
                document.getElementById('restoreError').style.display = 'none';
                document.getElementById('backupFileInput').value = '';
                document.getElementById('restorePhraseInput').value = '';
                restoreModal.show();
            });
            document.getElementById('confirmRestoreBtn').addEventListener('click', function () {
                var fileInput = document.getElementById('backupFileInput');
                var phrase = document.getElementById('restorePhraseInput').value.trim();
                var err = document.getElementById('restoreError');
                if (!fileInput.files || fileInput.files.length === 0) {
                    err.textContent = 'Selecione um arquivo ZIP para restaurar.';
                    err.style.display = 'block';
                    return;
                }
                if (phrase.toUpperCase() !== 'RESTAURAR BACKUP') {
                    err.textContent = 'Frase de confirmação incorreta.';
                    err.style.display = 'block';
                    return;
                }
                var fd = new FormData();
                fd.append('backup_file', fileInput.files[0]);
                fd.append('phrase', phrase);
                var btn = document.getElementById('confirmRestoreBtn');
                var origHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Restaurando...';

                fetch('/admin/restore', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: fd
                }).then(function (r) {
                    var ct = r.headers.get('content-type') || '';
                    if (ct.indexOf('application/json') !== -1) {
                        return r.json().then(function (data) {
                            if (!r.ok) throw new Error(data.msg || 'Falha na restauração');
                            return data;
                        });
                    }
                    return r.text().then(function (txt) {
                        if (!r.ok) { throw new Error(txt || 'Falha na restauração'); }
                        try {
                            var parsed = JSON.parse(txt);
                            return parsed;
                        } catch (e) {
                            return { ok: true };
                        }
                    });
                }).then(function (data) {
                    err.style.display = 'none';
                    restoreModal.hide();
                    // Mostrar o log/resultado no modal de resultado
                    var logContent = (typeof data === 'object') ? JSON.stringify(data, null, 2) : String(data);
                    var logEl = document.getElementById('restoreLogContent');
                    if (logEl) logEl.textContent = logContent;
                    var resultModalEl = document.getElementById('restoreResultModal');
                    if (resultModalEl) {
                        var resultModal = new bootstrap.Modal(resultModalEl);
                        resultModal.show();
                    } else {
                        showToast('Restauração concluída com sucesso.', 'success');
                        window.location.reload();
                    }
                }).catch(function (e) {
                    err.textContent = e.message || 'Erro ao restaurar backup.';
                    err.style.display = 'block';
                    // Mostrar erro detalhado no modal de resultado
                    var logEl = document.getElementById('restoreLogContent');
                    if (logEl) logEl.textContent = e.message || String(e);
                    var resultModalEl = document.getElementById('restoreResultModal');
                    if (resultModalEl) {
                        var resultModal = new bootstrap.Modal(resultModalEl);
                        resultModal.show();
                    }
                    showToast(err.textContent, 'danger');
                }).finally(function () {
                    btn.disabled = false;
                    btn.innerHTML = origHTML;
                });
            });
        }
        // Interceptar formulários que postam para /admin para mostrar feedback visual e evitar double submit
        document.querySelectorAll('form[action="/admin"]').forEach(function (f) {
            f.addEventListener('submit', function (e) {
                var btn = f.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = true;
                    var orig = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando...';
                }
                // allow normal submit (will reload page). Buttons will be reset on page load.
            });
        });

        // Hooks for restore result modal buttons
        var copyBtn = document.getElementById('copyRestoreLog');
        if (copyBtn) {
            copyBtn.addEventListener('click', function () {
                var logEl = document.getElementById('restoreLogContent');
                if (!logEl) return;
                navigator.clipboard.writeText(logEl.textContent || '').then(function () {
                    showToast('Log copiado para a área de transferência.', 'success');
                }).catch(function () {
                    showToast('Falha ao copiar o log.', 'danger');
                });
            });
        }
        var reloadBtn = document.getElementById('restoreReloadBtn');
        if (reloadBtn) {
            reloadBtn.addEventListener('click', function () {
                // fecha modal e recarrega
                var resModalEl = document.getElementById('restoreResultModal');
                if (resModalEl) {
                    var m = bootstrap.Modal.getInstance(resModalEl) || new bootstrap.Modal(resModalEl);
                    m.hide();
                }
                window.location.reload();
            });
        }

        // Backup modal buttons
        var copyBackup = document.getElementById('copyBackupLog');
        if (copyBackup) {
            copyBackup.addEventListener('click', function () {
                var el = document.getElementById('backupLogContent');
                if (!el) return;
                navigator.clipboard.writeText(el.textContent || '').then(function () { showToast('Log copiado.', 'success'); }).catch(function () { showToast('Falha ao copiar.', 'danger'); });
            });
        }
        var backupReload = document.getElementById('backupReloadBtn');
        if (backupReload) {
            backupReload.addEventListener('click', function () {
                var el = document.getElementById('backupResultModal');
                if (el) { var m = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el); m.hide(); }
                window.location.reload();
            });
        }
        var downloadBackupBtn = document.getElementById('downloadBackupBtn');
        if (downloadBackupBtn) {
            // nothing to do; href is set when backup created
        }

        // Global JS error handlers to surface problems to the user (helps debugging)
        window.addEventListener('error', function (ev) {
            try { showToast('Erro no cliente: ' + (ev.message || ev.error || 'unknown'), 'danger'); } catch (e) { }
        });
        window.addEventListener('unhandledrejection', function (ev) {
            try { showToast('Promise rejeitada: ' + (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason)), 'danger'); } catch (e) { }
        });
    });
</script>
{% endblock %}