{% extends "base.html" %}

{% block title %}Administração{% endblock %}

{% block content %}
<div class="row g-4 fade-in-up">
    <!-- Header Simples -->
    <div class="col-12 d-flex justify-content-between align-items-center mb-2">
        <div>
            <h2 class="fw-bold text-primary mb-0"><i class="bi bi-sliders me-2"></i>Painel Administrativo</h2>
            <p class="text-muted small mb-0">Gerenciamento e configurações do sistema</p>
        </div>
        <div class="text-end">
            <span class="badge bg-light text-dark border"><i class="bi bi-clock me-1"></i> {{ config.escola }}</span>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;"></div>

    {# Flashed messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flashedToasts" style="display:none;">
        {% for category, msg in messages %}
        <div class="flashed-message" data-category="{{ category }}">{{ msg }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Coluna Esquerda: Configurações (Accordion) -->
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-gear me-2"></i>Configurações Gerais</h5>
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="adminAccordion">

                    <!-- Item 1: Carteirinha -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCarteirinha">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseCarteirinha" aria-expanded="true"
                                aria-controls="collapseCarteirinha">
                                <i class="bi bi-card-heading me-2 text-primary"></i> Dados da Carteirinha
                            </button>
                        </h2>
                        <div id="collapseCarteirinha" class="accordion-collapse collapse show"
                            aria-labelledby="headingCarteirinha" data-bs-parent="#adminAccordion">
                            <div class="accordion-body bg-light-subtle">
                                <form method="POST" action="/admin" class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-secondary">Nome da Escola</label>
                                        <input type="text" class="form-control" name="CARTEIRINHA_ESCOLA"
                                            value="{{ config.escola }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-secondary">Telefone</label>
                                        <input type="text" class="form-control" name="CARTEIRINHA_TELEFONE"
                                            value="{{ config.telefone }}" required>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label small fw-bold text-secondary">Endereço</label>
                                        <input type="text" class="form-control" name="CARTEIRINHA_ENDERECO"
                                            value="{{ config.endereco }}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold text-secondary">Validade</label>
                                        <input type="text" class="form-control" name="CARTEIRINHA_VALIDADE"
                                            value="{{ config.validade }}" required>
                                    </div>
                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-sm btn-primary"><i
                                                class="bi bi-save me-1"></i> Salvar Dados</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Item 2: Identidade Visual -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingVisual">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseVisual" aria-expanded="false" aria-controls="collapseVisual">
                                <i class="bi bi-palette me-2 text-success"></i> Identidade Visual
                            </button>
                        </h2>
                        <div id="collapseVisual" class="accordion-collapse collapse" aria-labelledby="headingVisual"
                            data-bs-parent="#adminAccordion">
                            <div class="accordion-body bg-light-subtle">
                                <form method="POST" action="/admin" enctype="multipart/form-data"
                                    class="row g-3 align-items-end">
                                    <div class="col-md-5">
                                        <label class="form-label small fw-bold text-secondary">Assinatura (PNG)</label>
                                        <input class="form-control form-control-sm" type="file" name="assinatura"
                                            accept=".png">
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label small fw-bold text-secondary">Logo (SVG)</label>
                                        <input class="form-control form-control-sm" type="file" name="logo"
                                            accept=".svg">
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button type="submit" class="btn btn-sm btn-success w-100"><i
                                                class="bi bi-upload"></i></button>
                                    </div>
                                    <div class="col-12 form-text small text-muted mt-1">
                                        Formatos obrigatórios: PNG transparente para assinatura, SVG para logo.
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Item 3: Telegram -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTelegram">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTelegram" aria-expanded="false"
                                aria-controls="collapseTelegram">
                                <i class="bi bi-telegram me-2 text-info"></i> Integração Telegram
                            </button>
                        </h2>
                        <div id="collapseTelegram" class="accordion-collapse collapse" aria-labelledby="headingTelegram"
                            data-bs-parent="#adminAccordion">
                            <div class="accordion-body bg-light-subtle">
                                <form method="POST" action="/admin" class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-secondary">Token do Bot</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white text-muted"><i
                                                    class="bi bi-key"></i></span>
                                            <input type="text" class="form-control" name="TELEGRAM_TOKEN"
                                                value="{{ token }}" placeholder="Insira o Token do BotFather">
                                            <button type="submit" class="btn btn-info text-white">Salvar</button>
                                        </div>
                                        <div class="form-text text-warning small mt-2">
                                            <i class="bi bi-info-circle me-1"></i> Reinicie o servidor após alterar o
                                            token.
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Coluna Direita: Manutenção e Sistema -->
    <div class="col-12 col-lg-5">

        <!-- Cartão de Manutenção Unificado -->
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-tools me-2"></i>Manutenção</h5>
            </div>
            <div class="list-group list-group-flush">
                <!-- Backup -->
                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                    <div>
                        <h6 class="mb-0 fw-bold text-dark">Backup</h6>
                        <small class="text-muted">Baixar dados (ZIP)</small>
                    </div>
                    <button id="backupBtn" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                        <i class="bi bi-download me-1"></i> Baixar
                    </button>
                </div>
                <!-- Restore -->
                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                    <div>
                        <h6 class="mb-0 fw-bold text-dark">Restauração</h6>
                        <small class="text-muted">Recuperar dados</small>
                    </div>
                    <button id="restoreBtn" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
                        <i class="bi bi-upload me-1"></i> Restaurar
                    </button>
                </div>
                <!-- Restart -->
                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                    <div>
                        <h6 class="mb-0 fw-bold text-warning">Reiniciar</h6>
                        <small class="text-muted">Aplicar configs</small>
                    </div>
                    <button id="restartBtn" class="btn btn-outline-warning btn-sm rounded-pill px-3">
                        <i class="bi bi-power me-1"></i> Reiniciar
                    </button>
                </div>
            </div>
        </div>

        <!-- Links Rápidos e Danger Zone Compacta -->
        <div class="row g-3">
            <div class="col-6">
                <div class="card shadow-sm h-100 border-0 text-center hover-card">
                    <a href="{{ url_for('admin_legacy_index') }}"
                        class="text-decoration-none text-dark card-body d-flex flex-column justify-content-center align-items-center">
                        <i class="bi bi-archive fs-2 text-secondary mb-2"></i>
                        <h6 class="fw-bold mb-0">Arquivo Morto</h6>
                        <small class="text-muted">Histórico anual</small>
                    </a>
                </div>
            </div>
            <div class="col-6">
                <div class="card shadow-sm h-100 border-0 border-start border-4 border-danger text-center hover-card">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center cursor-pointer"
                        id="openClearModal">
                        <i class="bi bi-trash3 fs-2 text-danger mb-2"></i>
                        <h6 class="fw-bold text-danger mb-0">Zerar Dados</h6>
                        <small class="text-danger-emphasis">Limpeza total</small>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ================= MODALS (Mantidos e Preservados) ================= -->

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Restaurar Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small border-0 bg-warning-subtle text-warning-emphasis">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Isso substituirá todos os dados atuais.
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Arquivo ZIP</label>
                    <input id="backupFileInput" type="file" accept=".zip" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Confirmação de Segurança</label>
                    <input id="restorePhraseInput" class="form-control" placeholder="Digite: RESTAURAR BACKUP">
                </div>
                <div id="restoreError" class="text-danger small fw-bold mt-2" style="display:none;"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button id="confirmRestoreBtn" type="button" class="btn btn-warning">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Result Modal -->
<div class="modal fade" id="restoreResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log de Restauração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <pre id="restoreLogContent" class="m-0 p-3 bg-dark text-light small font-monospace"
                    style="max-height:400px; overflow:auto;"></pre>
            </div>
            <div class="modal-footer">
                <button id="copyRestoreLog" type="button" class="btn btn-outline-secondary btn-sm">Copiar Log</button>
                <button id="restoreReloadBtn" type="button" class="btn btn-primary btn-sm">Concluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Result Modal -->
<div class="modal fade" id="backupResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log de Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <pre id="backupLogContent" class="m-0 p-3 bg-dark text-light small font-monospace"
                    style="max-height:400px; overflow:auto;"></pre>
            </div>
            <div class="modal-footer">
                <button id="copyBackupLog" type="button" class="btn btn-outline-secondary btn-sm">Copiar Log</button>
                <a id="downloadBackupBtn" class="btn btn-success btn-sm" href="#" download style="display:none;">Baixar
                    ZIP</a>
                <button id="backupReloadBtn" type="button" class="btn btn-primary btn-sm">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Data Modal -->
<div class="modal fade" id="clearModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-top border-5 border-danger">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger fw-bold"><i class="bi bi-exclamation-octagon me-2"></i>Zona de Perigo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Para limpar todos os dados do sistema, preencha as verificações abaixo:</p>
                <div class="vstack gap-3">
                    <div>
                        <label class="form-label small fw-bold text-secondary mb-1">1. Token do Servidor</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text font-monospace bg-light">{{ clear_token }}</span>
                            <input id="tokenInput" class="form-control" placeholder="Repita o token">
                        </div>
                    </div>
                    <div>
                        <label class="form-label small fw-bold text-secondary mb-1">2. Desafio Matemático</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text font-monospace bg-light">{{ math_question }}</span>
                            <input id="mathInput" class="form-control" placeholder="Responda">
                        </div>
                    </div>
                    <div>
                        <label class="form-label small fw-bold text-secondary mb-1">3. Frase de Confirmação</label>
                        <input id="phraseInput" class="form-control form-control-sm" placeholder="Digite: LIMPAR TUDO">
                    </div>
                </div>
                <div id="clearError" class="alert alert-danger py-2 small mt-3 mb-0" style="display:none;"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button id="confirmClearBtn" type="button" class="btn btn-danger">Confirmar Limpeza</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS Adicional para Cards Interativos -->
<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .hover-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
        color: #0d6efd;
    }

    .fade-in-up {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Helper: Toasts ---
        function showToast(message, type) {
            type = type || 'success';
            var toastContainer = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast align-items-center border-0 shadow-sm mb-2';

            // Estilos BS5
            if (type === 'success') toast.classList.add('text-bg-success');
            else if (type === 'error' || type === 'danger') toast.classList.add('text-bg-danger');
            else if (type === 'info') toast.classList.add('text-bg-info');
            else toast.classList.add('text-bg-light');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body fw-bold">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;

            toastContainer.appendChild(toast);
            var bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // --- Flash Messages ---
        var flashed = document.getElementById('flashedToasts');
        if (flashed) {
            flashed.querySelectorAll('.flashed-message').forEach(it => {
                var cat = it.getAttribute('data-category') || 'info';
                showToast(it.textContent.trim(), cat === 'success' ? 'success' : (cat === 'error' ? 'danger' : 'info'));
            });
        }

        // --- Clear Data Logic ---
        var clearModal = new bootstrap.Modal(document.getElementById('clearModal'));
        document.getElementById('openClearModal').addEventListener('click', function () {
            document.getElementById('clearError').style.display = 'none';
            document.getElementById('tokenInput').value = '';
            document.getElementById('mathInput').value = '';
            document.getElementById('phraseInput').value = '';
            clearModal.show();
        });

        document.getElementById('confirmClearBtn').addEventListener('click', function () {
            var token = document.getElementById('tokenInput').value.trim();
            var math = document.getElementById('mathInput').value.trim();
            var phrase = document.getElementById('phraseInput').value.trim();
            var err = document.getElementById('clearError');

            if (!token || !math || !phrase) {
                err.textContent = 'Preencha todos os campos.';
                err.style.display = 'block';
                return;
            }

            var btn = this;
            var oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>...';

            fetch('/admin/clear_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, math: math, phrase: phrase })
            }).then(r => r.json().catch(() => ({ ok: false, msg: "Erro de parse" }))
                .then(data => ({ status: r.status, ok: r.ok, body: data }))
            ).then(res => {
                if (!res.ok) throw new Error(res.body.msg || 'Falha na validação');
                err.style.display = 'none';
                clearModal.hide();
                showToast('Limpeza concluída com sucesso!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            }).catch(e => {
                err.textContent = e.message;
                err.style.display = 'block';
            }).finally(() => {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            });
        });

        // --- Backup Logic ---
        var backupBtn = document.getElementById('backupBtn');
        if (backupBtn) {
            backupBtn.addEventListener('click', function () {
                var btn = this;
                var oldHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                fetch('/admin/backup_api')
                    .then(r => r.json().catch(() => ({})).then(d => ({ ok: r.ok, data: d })))
                    .then(res => {
                        var log = JSON.stringify(res.data, null, 2);
                        document.getElementById('backupLogContent').textContent = log;

                        var dlBtn = document.getElementById('downloadBackupBtn');
                        if (res.data.download_url) {
                            dlBtn.href = res.data.download_url;
                            dlBtn.style.display = 'inline-block';
                            // auto trigger
                            var a = document.createElement('a');
                            a.href = res.data.download_url;
                            a.download = res.data.filename || 'backup.zip';
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => a.remove(), 2000);
                            showToast('Download iniciado.', 'success');
                        }

                        // Show result modal mainly for log if needed, but if auto-downloaded maybe skip?
                        // User request: "conciso". Let's show modal only if error or explicit success info needed.
                        // Impl: Always show modal for transparency of log
                        new bootstrap.Modal(document.getElementById('backupResultModal')).show();
                    })
                    .catch(e => showToast('Erro no backup: ' + e, 'danger'))
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerHTML = oldHtml;
                    });
            });
        }

        // --- Restore Logic ---
        var restoreBtn = document.getElementById('restoreBtn');
        var restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
        if (restoreBtn) {
            restoreBtn.addEventListener('click', () => {
                document.getElementById('restoreError').style.display = 'none';
                document.getElementById('backupFileInput').value = '';
                document.getElementById('restorePhraseInput').value = '';
                restoreModal.show();
            });
        }

        document.getElementById('confirmRestoreBtn').addEventListener('click', function () {
            var file = document.getElementById('backupFileInput').files[0];
            var phrase = document.getElementById('restorePhraseInput').value.trim();
            var err = document.getElementById('restoreError');

            if (!file || phrase.toUpperCase() !== 'RESTAURAR BACKUP') {
                err.textContent = 'Verifique o arquivo e a frase de confirmação.';
                err.style.display = 'block';
                return;
            }

            var btn = this;
            var oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Restaurando...';

            var fd = new FormData();
            fd.append('backup_file', file);
            fd.append('phrase', phrase);

            fetch('/admin/restore', { method: 'POST', body: fd })
                .then(r => r.json().catch(() => ({})).then(d => ({ ok: r.ok, data: d })))
                .then(res => {
                    restoreModal.hide();
                    document.getElementById('restoreLogContent').textContent = JSON.stringify(res.data, null, 2);
                    new bootstrap.Modal(document.getElementById('restoreResultModal')).show();
                    if (!res.ok) throw new Error(res.data.msg || 'Erro na restauração');
                })
                .catch(e => showToast(e.message, 'danger'))
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = oldHtml;
                });
        });

        // --- Restart Logic ---
        var restartBtn = document.getElementById('restartBtn');
        if (restartBtn) {
            restartBtn.addEventListener('click', function () {
                if (!confirm('O servidor ficará indisponível por alguns segundos. Continuar?')) return;

                var btn = this;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                fetch('/admin/restart', { method: 'POST' })
                    .then(r => {
                        if (r.ok) {
                            showToast('Sistema reiniciando...', 'warning');
                            setTimeout(() => window.location.reload(), 5000);
                        } else throw new Error('Falha');
                    })
                    .catch(() => {
                        showToast('Erro ao reiniciar.', 'danger');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-power me-1"></i> Reiniciar';
                    });
            });
        }

        // --- Utils: Modal Reloads & Copy ---
        ['restoreReloadBtn', 'backupReloadBtn'].forEach(id => {
            var el = document.getElementById(id);
            if (el) el.addEventListener('click', () => window.location.reload());
        });

        document.getElementById('copyRestoreLog').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('restoreLogContent').textContent);
            showToast('Copiado!', 'success');
        });
        document.getElementById('copyBackupLog').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('backupLogContent').textContent);
            showToast('Copiado!', 'success');
        });

        // --- Prevent Double Submit on Forms ---
        document.querySelectorAll('form').forEach(f => {
            f.addEventListener('submit', function () {
                var b = f.querySelector('button[type="submit"]');
                if (b) {
                    var w = b.offsetWidth;
                    b.disabled = true;
                    b.style.width = w + 'px';
                    b.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                }
            });
        });
    });
</script>
{% endblock %}