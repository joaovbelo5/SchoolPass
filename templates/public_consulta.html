<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Pública</title>
    <!-- Preconnect for Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            min-height: 100vh;
        }

        .text-primary-custom {
            color: #059669 !important;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="text-center mb-5">
                    <h1 class="fw-bold text-white mb-2">
                        <i class="bi bi-person-badge me-2"></i>SchoolPass
                    </h1>
                    <p class="text-white-50">Consulta Pública de Alunos</p>
                </div>

                <!-- Search Card -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 text-primary fw-bold">
                            <i class="bi bi-search me-2"></i>Consultar Aluno
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="POST" action="{{ url_for('public_consulta') }}">
                            <div class="mb-3">
                                <label for="codigo" class="form-label fw-bold text-secondary">Código da
                                    Carteirinha</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="bi bi-upc-scan"></i></span>
                                    <input type="text" class="form-control" id="codigo" name="codigo" required
                                        placeholder="Ex: 2023001">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="turma" class="form-label fw-bold text-secondary">Turma</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="bi bi-people"></i></span>
                                    <input type="text" class="form-control" id="turma" name="turma" required
                                        placeholder="Ex: 9A">
                                </div>
                            </div>

                            <div class="alert alert-info d-flex align-items-center shadow-sm mb-4" role="alert">
                                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                <div class="small">
                                    <strong>Atenção:</strong> Os dados devem ser idênticos aos da carteirinha. Em caso
                                    de
                                    dúvidas, procure a secretaria.
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" name="action" value="registros"
                                    class="btn btn-primary btn-lg fw-bold">
                                    <i class="bi bi-clock-history me-2"></i>Ver Histórico
                                </button>
                                <button type="submit" name="action" value="carteirinha"
                                    class="btn btn-outline-secondary btn-lg fw-bold">
                                    <i class="bi bi-card-heading me-2"></i>Emitir 2ª Via
                                </button>
                            </div>
                        </form>

                        <div class="text-center mt-4">
                            <a href="{{ url_for('cadastro_telegram') }}"
                                class="text-decoration-none fw-bold text-success">
                                <i class="bi bi-telegram me-1"></i>Configurar alertas no Telegram
                            </a>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="alert alert-danger d-flex align-items-center shadow-sm" role="alert">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                    <div>{{ error }}</div>
                </div>
                {% endif %}

                {% if registros %}
                <!-- Results Card -->
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-white py-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle p-2 me-3">
                                <i class="bi bi-person-fill fs-4 text-primary"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 fw-bold">{{ aluno.Nome }}</h5>
                                <small class="text-muted">Turma: {{ aluno.Turma }}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                            <i class="bi bi-printer me-2"></i>Imprimir
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="bg-light p-3 border-bottom">
                            <h6 class="fw-bold text-secondary mb-0">Histórico de Registros</h6>
                        </div>
                        <div class="p-3">
                            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                {% if registros.historico %}
                                {% for item in registros.historico | reverse %}
                                <div
                                    class="list-group-item px-3 py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        {% if 'entrada' in item.tipo.lower() or 'acesso' in item.tipo.lower() %}
                                        <i class="bi bi-check-circle-fill text-success fs-5 me-3"></i>
                                        {% else %}
                                        <i class="bi bi-circle-fill text-secondary fs-6 me-3 ms-1"></i>
                                        {% endif %}
                                        <div>
                                            <div class="fw-bold">{{ item.tipo }}</div>
                                        </div>
                                    </div>
                                    <span class="badge bg-light text-dark border">{{ item.data_hora }}</span>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="p-4 text-center text-muted">Ainda não há registros para este aluno.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Version (Hidden on Screen) -->
                <div id="versao-impressao" class="d-none d-print-block">
                    <div class="text-center mb-4">
                        <h2>Histórico de Acessos</h2>
                        <p>{{ aluno.Nome }} - Turma {{ aluno.Turma }}</p>
                        <hr>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm"
                            style="font-family: 'Courier New', monospace; width: 100%;">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in registros.historico | reverse %}
                                <tr>
                                    <td>{{ item.data_hora }}</td>
                                    <td>{{ item.tipo }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center">Nenhum registro encontrado.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-5 text-muted small">
                        Documento gerado em: {{ now.strftime('%d/%m/%Y às %H:%M') }}
                    </div>
                </div>

                <style media="print">
                    body * {
                        visibility: hidden;
                    }

                    #versao-impressao,
                    #versao-impressao * {
                        visibility: visible;
                    }

                    #versao-impressao {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                        padding: 2cm;
                    }

                    @page {
                        margin: 0;
                    }
                </style>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>